#!/bin/sh
# Installation of basic build dependencies
echo "$MSG_BUILDDEP"
if [ $SUDO = yes ]; then
  $UNENCRYTEDPASSWD
  echo $PASSWD | sudo -SE yum install gettext gcc autoconf libtool automake make asciidoc xmlto curl git python3-jinja2 -y
  $ENCRYTEDPASSWD
elif [ $SUDO = no ]; then
  yum install gettext gcc autoconf libtool automake make asciidoc xmlto curl git python3-jinja2 -y
fi

# Install port occupancy detection tool
echo "$MSG_PORT_CHECK"
if [ $SUDO = yes ]; then
  $UNENCRYTEDPASSWD
  echo $PASSWD | sudo -SE yum install lsof -y
  $ENCRYTEDPASSWD
elif [ $SUDO = no ]; then
  yum install lsof -y
fi

# Install user-space interfaces to the POSIX 1003.1e capabilities available in Linux kernels
echo "$MSG_CAP2"
if [ $SUDO = yes ]; then
  $UNENCRYTEDPASSWD
  echo $PASSWD | sudo -SE yum install libcap2 -y
  $ENCRYTEDPASSWD
elif [ $SUDO = no ]; then
  yum install libcap2 -y
fi

# Install psmisc for service restart after ss_update
echo "$MSG_PSMISC"
if [ $SUDO = yes ]; then
  $UNENCRYTEDPASSWD
  echo $PASSWD | sudo -SE yum install psmisc -y
  $ENCRYTEDPASSWD
elif [ $SUDO = no ]; then
  yum install psmisc -y
fi

if [ ! -f $WORKDIRECTORY/lib/libsodium.a ]; then
. $DEP/libsodium
fi
if [ ! -f $WORKDIRECTORY/lib/libmbedtls.a ]; then
. $DEP/mbedtls
fi
if [ ! -f $WORKDIRECTORY/lib/libpcre.la ]; then
. $DEP/pcre
fi
if [ ! -f $WORKDIRECTORY/lib/libev.la ]; then
. $DEP/libev
fi
if [ ! -f $WORKDIRECTORY/lib/libcares.la ]; then
. $DEP/c-ares
fi
export PATH=$WORKDIRECTORY/bin:$PATH
echo "export PATH=$WORKDIRECTORY/bin:\$PATH" >>$WORKDIRECTORY/envsetup.sh

if [ ! -f $WORKDIRECTORY/bin/ss-server ]; then
. $DEP/shadowsocks
fi
